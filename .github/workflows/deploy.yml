name: Deploy Portfolio

on:
  workflow_run:
    workflows: ["CI - Test & Quality Checks"]
    types:
      - completed
    branches: [ main, develop, uat ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # Check if tests passed before deploying
  check-tests:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    outputs:
      deploy-uat: ${{ steps.check-branch.outputs.deploy-uat }}
      deploy-production: ${{ steps.check-branch.outputs.deploy-production }}
    
    steps:
    - name: Check branch and set deployment flags
      id: check-branch
      run: |
        if [[ "${{ github.event.workflow_run.head_branch }}" == "develop" || "${{ github.event.workflow_run.head_branch }}" == "uat" ]]; then
          echo "deploy-uat=true" >> $GITHUB_OUTPUT
          echo "deploy-production=false" >> $GITHUB_OUTPUT
        elif [[ "${{ github.event.workflow_run.head_branch }}" == "main" ]]; then
          echo "deploy-uat=false" >> $GITHUB_OUTPUT
          echo "deploy-production=true" >> $GITHUB_OUTPUT
        else
          echo "deploy-uat=false" >> $GITHUB_OUTPUT
          echo "deploy-production=false" >> $GITHUB_OUTPUT
        fi

  # UAT Environment (develop/uat branch)
  deploy-uat:
    needs: check-tests
    if: needs.check-tests.outputs.deploy-uat == 'true'
    runs-on: ubuntu-latest
    environment:
      name: uat
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.workflow_run.head_sha }}
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v4
      with:
        path: '.'
        
    - name: Deploy to UAT
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: UAT Deployment Success
      run: |
        echo "ğŸ‰ UAT deployment successful!"
        echo "ğŸ“ URL: ${{ steps.deployment.outputs.page_url }}"

  # Production Environment (main branch)
  deploy-production:
    needs: check-tests
    if: needs.check-tests.outputs.deploy-production == 'true'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.workflow_run.head_sha }}
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v4
      with:
        path: '.'
        
    - name: Deploy to Production
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Production Deployment Success
      run: |
        echo "ğŸš€ Production deployment successful!"
        echo "ğŸ“ URL: ${{ steps.deployment.outputs.page_url }}"
        
  # Notify on test failure
  notify-test-failure:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure'
    
    steps:
    - name: Tests Failed - Deployment Blocked
      run: |
        echo "âŒ Tests failed on branch: ${{ github.event.workflow_run.head_branch }}"
        echo "ğŸš« Deployment has been blocked"
        echo "ğŸ“‹ Please check the test results and fix any issues before deployment"
        exit 1
    
    - name: Send deployment blocked notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "ğŸš« Portfolio Deployment Blocked - Tests Failed on ${{ github.event.workflow_run.head_branch }}"
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: "GitHub Actions <${{ secrets.EMAIL_USERNAME }}>"
        html_body: |
          <h2>ğŸš« Deployment Blocked</h2>
          <p><strong>Repository:</strong> ${{ github.repository }}</p>
          <p><strong>Branch:</strong> ${{ github.event.workflow_run.head_branch }}</p>
          <p><strong>Commit:</strong> ${{ github.event.workflow_run.head_sha }}</p>
          <p><strong>Triggered by:</strong> ${{ github.actor }}</p>
          
          <h3>âš ï¸ Issue:</h3>
          <p>Tests failed in the CI pipeline, preventing deployment to proceed.</p>
          
          <h3>ğŸ”— Links:</h3>
          <p><a href="${{ github.event.workflow_run.html_url }}">View Failed Test Run</a></p>
          <p><a href="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.event.workflow_run.head_sha }}">View Commit</a></p>
          
          <p><em>Deployment will automatically proceed once tests pass.</em></p>

  # Notify on deployment success
  notify-deployment-success:
    runs-on: ubuntu-latest
    needs: [deploy-uat, deploy-production]
    if: always() && (needs.deploy-uat.result == 'success' || needs.deploy-production.result == 'success')
    
    steps:
    - name: Send deployment success notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "âœ… Portfolio Deployed Successfully to ${{ needs.deploy-production.result == 'success' && 'Production' || 'UAT' }}"
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: "GitHub Actions <${{ secrets.EMAIL_USERNAME }}>"
        html_body: |
          <h2>âœ… Deployment Successful</h2>
          <p><strong>Repository:</strong> ${{ github.repository }}</p>
          <p><strong>Branch:</strong> ${{ github.event.workflow_run.head_branch }}</p>
          <p><strong>Environment:</strong> ${{ needs.deploy-production.result == 'success' && 'Production' || 'UAT' }}</p>
          <p><strong>Commit:</strong> ${{ github.event.workflow_run.head_sha }}</p>
          <p><strong>Triggered by:</strong> ${{ github.actor }}</p>
          
          <h3>ğŸš€ Deployment Details:</h3>
          <p>Your portfolio has been successfully deployed and is now live!</p>
          
          <h3>ğŸ”— Links:</h3>
          <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Deployment Run</a></p>
          <p><a href="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.event.workflow_run.head_sha }}">View Commit</a></p>
          <p><a href="https://3elgrey.github.io/">View Live Site</a></p>
          
          <p><em>ğŸ‰ Your changes are now live!</em></p>
