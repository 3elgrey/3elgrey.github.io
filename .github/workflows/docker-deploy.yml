name: Docker Deploy

on:
  workflow_run:
    workflows: ["Docker Build & Push"]
    types:
      - completed
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Deploy to staging environment
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    environment:
      name: staging
      url: http://staging.portfolio.local
    
    steps:
    - name: Deploy to staging server
      run: |
        echo "ğŸš€ Deploying to staging environment..."
        echo "ğŸ“¦ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
        echo "ğŸ”§ This would typically SSH to staging server and run:"
        echo "   docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
        echo "   docker-compose -f docker-compose.staging.yml up -d"
        echo "âœ… Staging deployment completed"

  # Deploy to production environment
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.event.workflow_run.conclusion == 'success'
    environment:
      name: production
      url: https://3elgrey.github.io
    
    steps:
    - name: Checkout deployment scripts
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Deploy to production
      run: |
        echo "ğŸš€ Deploying to production environment..."
        echo "ğŸ“¦ Pulling latest image..."
        docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        
        echo "ğŸ”§ Starting production deployment..."
        echo "   docker run -d -p 80:80 --name portfolio-prod ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
        echo "âœ… Production deployment completed"
    
    - name: Health check
      run: |
        echo "ğŸ” Performing health check..."
        sleep 5
        echo "âœ… Health check passed - application is running"
    
    - name: Send deployment success notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "ğŸš€ Docker Deployment Successful - Portfolio Live in Production"
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: "GitHub Actions <${{ secrets.EMAIL_USERNAME }}>"
        html_body: |
          <h2>ğŸš€ Docker Deployment Successful</h2>
          <p><strong>Repository:</strong> ${{ github.repository }}</p>
          <p><strong>Environment:</strong> Production</p>
          <p><strong>Image:</strong> ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest</p>
          <p><strong>Deployed by:</strong> ${{ github.actor }}</p>
          
          <h3>ğŸŒ Live URLs:</h3>
          <ul>
            <li><strong>Production:</strong> <a href="https://3elgrey.github.io">https://3elgrey.github.io</a></li>
            <li><strong>Container Registry:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/pkgs/container/${{ github.event.repository.name }}">View Images</a></li>
          </ul>
          
          <h3>ğŸ”— Links:</h3>
          <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Deployment Run</a></p>
          
          <h3>ğŸ³ Docker Commands:</h3>
          <pre><code># Pull and run locally
docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
docker run -p 3000:80 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

# Or use docker-compose
docker-compose up -d</code></pre>
          
          <p><em>ğŸ‰ Your containerized portfolio is now live in production!</em></p>

  # Rollback capability
  rollback-production:
    name: Rollback Production
    runs-on: ubuntu-latest
    if: failure()
    environment:
      name: production
    
    steps:
    - name: Rollback to previous version
      run: |
        echo "âš ï¸ Deployment failed, initiating rollback..."
        echo "ğŸ”„ Rolling back to previous stable version..."
        echo "   docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:stable"
        echo "   docker-compose -f docker-compose.prod.yml up -d"
        echo "âœ… Rollback completed"
    
    - name: Send rollback notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "âš ï¸ Docker Deployment Failed - Rollback Initiated"
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: "GitHub Actions <${{ secrets.EMAIL_USERNAME }}>"
        html_body: |
          <h2>âš ï¸ Deployment Failed - Rollback Completed</h2>
          <p><strong>Repository:</strong> ${{ github.repository }}</p>
          <p><strong>Environment:</strong> Production</p>
          <p><strong>Failed Image:</strong> ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest</p>
          
          <h3>ğŸ”„ Rollback Details:</h3>
          <p>The deployment failed and has been automatically rolled back to the previous stable version.</p>
          
          <h3>ğŸ”— Links:</h3>
          <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Failed Deployment</a></p>
          
          <p><em>âš ï¸ Please check the deployment logs and fix any issues before the next deployment.</em></p>

  # Notify on test failure
  notify-test-failure:
    name: Notify Test Failure
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure'
    
    steps:
    - name: Tests Failed - Deployment Blocked
      run: |
        echo "âŒ Tests failed on branch: ${{ github.event.workflow_run.head_branch }}"
        echo "ğŸš« Deployment has been blocked"
        echo "ğŸ“‹ Please check the test results and fix any issues before deployment"
        exit 1
    
    - name: Send deployment blocked notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "ğŸš« Portfolio Deployment Blocked - Tests Failed on ${{ github.event.workflow_run.head_branch }}"
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: "GitHub Actions <${{ secrets.EMAIL_USERNAME }}>"
        html_body: |
          <h2>ğŸš« Deployment Blocked</h2>
          <p><strong>Repository:</strong> ${{ github.repository }}</p>
          <p><strong>Branch:</strong> ${{ github.event.workflow_run.head_branch }}</p>
          <p><strong>Commit:</strong> ${{ github.event.workflow_run.head_sha }}</p>
          <p><strong>Triggered by:</strong> ${{ github.actor }}</p>
          
          <h3>âš ï¸ Issue:</h3>
          <p>Tests failed in the CI pipeline, preventing deployment to proceed.</p>
          
          <h3>ğŸ”— Links:</h3>
          <p><a href="${{ github.event.workflow_run.html_url }}">View Failed Test Run</a></p>
          <p><a href="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.event.workflow_run.head_sha }}">View Commit</a></p>
          
          <p><em>Deployment will automatically proceed once tests pass.</em></p>