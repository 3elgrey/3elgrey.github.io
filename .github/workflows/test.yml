name: CI - Test & Quality Checks

on:
  push:
    branches: [ main, develop, uat ]
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

# Cancel in-progress runs for the same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    - name: Install dependencies
      run: |
        if [ -f package-lock.json ]; then
          echo "ğŸ“¦ Using npm ci (package-lock.json found)"
          npm ci
        else
          echo "ğŸ“¦ Using npm install (no package-lock.json)"
          npm install
        fi
    
    - name: Run unit tests
      run: npm test
    
    - name: Run tests with coverage
      run: npm run test:coverage
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      if: always()
      with:
        fail_ci_if_error: false
    
    - name: Upload coverage artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: coverage/
        retention-days: 30
    
    - name: Generate test summary
      if: always()
      run: |
        echo "## ğŸ“Š Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… **All tests passed successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "ğŸš€ Ready for deployment!" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Tests failed**" >> $GITHUB_STEP_SUMMARY
          echo "ğŸš« Deployment blocked" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f coverage/lcov-report/index.html ]; then
          echo "ğŸ“ˆ **Coverage Report:** Available in artifacts" >> $GITHUB_STEP_SUMMARY
        fi

  validate-structure:
    name: Validate Project Structure
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Validate HTML structure
      run: |
        if [ -f "index.html" ]; then
          echo "âœ… index.html found"
          # Basic HTML validation
          if grep -q "<!DOCTYPE html>" index.html; then
            echo "âœ… Valid HTML5 DOCTYPE"
          else
            echo "âŒ Missing or invalid DOCTYPE"
            exit 1
          fi
        else
          echo "âŒ index.html not found"
          exit 1
        fi
    
    - name: Check required files
      run: |
        echo "ğŸ“ Checking project structure..."
        required_files=("index.html" "style.css" "script.js" "package.json")
        missing_files=()
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file found"
          else
            echo "âŒ $file not found"
            missing_files+=("$file")
          fi
        done
        
        if [ ${#missing_files[@]} -ne 0 ]; then
          echo "âŒ Missing required files: ${missing_files[*]}"
          exit 1
        fi
        echo "âœ… All required files present"
    
    - name: Validate CSS syntax
      run: |
        if [ -f "style.css" ]; then
          echo "âœ… CSS file found"
          # Basic CSS validation
          if grep -q "body\s*{" style.css; then
            echo "âœ… CSS appears to have basic structure"
          else
            echo "âš ï¸ CSS may be missing basic body styles"
          fi
        fi
    
    - name: Validate JavaScript syntax
      run: |
        if [ -f "script.js" ]; then
          echo "âœ… JavaScript file found"
          # Basic JS validation using Node.js
          node -c script.js
          echo "âœ… JavaScript syntax is valid"
        fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    - name: Install dependencies
      run: |
        if [ -f package-lock.json ]; then
          npm ci
        else
          npm install
        fi
    
    - name: Run security audit
      run: |
        echo "ğŸ” Running security audit..."
        npm audit --audit-level=moderate
    
    - name: Check for high severity vulnerabilities
      run: |
        echo "ğŸ” Checking for high severity vulnerabilities..."
        # npm audit exits with code 0 if no vulnerabilities, non-zero if vulnerabilities found
        if ! npm audit --audit-level=high > /dev/null 2>&1; then
          echo "âŒ High severity vulnerabilities found"
          echo "ğŸ“‹ Vulnerability details:"
          npm audit --audit-level=high
          exit 1
        else
          echo "âœ… No high severity vulnerabilities found"
        fi

  # This job will only run if all other jobs pass
  tests-passed:
    name: All Tests Passed
    runs-on: ubuntu-latest
    needs: [test, validate-structure, security-scan]
    if: always()
    
    steps:
    - name: Check test results
      run: |
        if [[ "${{ needs.test.result }}" == "success" && 
              "${{ needs.validate-structure.result }}" == "success" && 
              "${{ needs.security-scan.result }}" == "success" ]]; then
          echo "âœ… All tests passed successfully!"
          echo "ğŸš€ Ready for deployment"
        else
          echo "âŒ Some tests failed:"
          echo "  - Unit Tests: ${{ needs.test.result }}"
          echo "  - Structure Validation: ${{ needs.validate-structure.result }}"
          echo "  - Security Scan: ${{ needs.security-scan.result }}"
          exit 1
        fi

  # Notification job for test failures
  notify-test-failure:
    name: Notify Test Failure
    runs-on: ubuntu-latest
    needs: [test, validate-structure, security-scan]
    if: failure()
    
    steps:
    - name: Send email notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "ğŸš¨ Portfolio CI/CD - Tests Failed on ${{ github.ref_name }}"
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: "GitHub Actions <${{ secrets.EMAIL_USERNAME }}>"
        html_body: |
          <h2>ğŸš¨ Test Failure Alert</h2>
          <p><strong>Repository:</strong> ${{ github.repository }}</p>
          <p><strong>Branch:</strong> ${{ github.ref_name }}</p>
          <p><strong>Commit:</strong> ${{ github.sha }}</p>
          <p><strong>Triggered by:</strong> ${{ github.actor }}</p>
          <p><strong>Workflow:</strong> ${{ github.workflow }}</p>
          
          <h3>ğŸ“‹ Test Results:</h3>
          <ul>
            <li><strong>Unit Tests:</strong> ${{ needs.test.result }}</li>
            <li><strong>Structure Validation:</strong> ${{ needs.validate-structure.result }}</li>
            <li><strong>Security Scan:</strong> ${{ needs.security-scan.result }}</li>
          </ul>
          
          <h3>ğŸ”— Links:</h3>
          <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Workflow Run</a></p>
          <p><a href="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}">View Commit</a></p>
          
          <p><em>Please check the failed tests and fix the issues before merging.</em></p>
        
    - name: Send Slack notification (optional)
      if: vars.SLACK_WEBHOOK_URL
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        text: |
          ğŸš¨ *Portfolio Tests Failed*
          
          *Repository:* ${{ github.repository }}
          *Branch:* ${{ github.ref_name }}
          *Commit:* ${{ github.sha }}
          *Actor:* ${{ github.actor }}
          
          *Test Results:*
          â€¢ Unit Tests: ${{ needs.test.result }}
          â€¢ Structure Validation: ${{ needs.validate-structure.result }}
          â€¢ Security Scan: ${{ needs.security-scan.result }}
          
          <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>